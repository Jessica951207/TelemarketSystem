<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>线索详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="css/page.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <!-- <link rel="stylesheet" href="../js/lay-module/inputTags/inputTags.css" media="all"> -->
    <style>
        .layui-form-label{
            width: 85px;
        }
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <div id="deleteBorder">
            <!-- 客户基本信息 -->
            <input type="hidden" id="boIdHidden" value=""/>
            <!-- 其他联系方式列表操作是否可操作，默认可操作 -->
            <input type="hidden" id="otherContacts_operation" value="0"/>
            <div id="customerInfoDiv">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>客户基本信息</legend>
                </fieldset>
                <!--layui-col-xs12 layui-col-sm6 layui-col-md6-->
                <form class="layui-form" action="" lay-filter="orgInfo" id="orgInfo">
                    <input type="hidden" id="boSaleUserId" name="boSaleUserId"/>
                    <div class="layui-form-item">
                        <div class="layui-inline ">
                            <label class="layui-form-label">客户姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" id="customerName" name="customerName" lay-filter="customerName" lay-verify="required" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline" style="line-height:37px">
                            <label class="layui-form-label">客户编号</label>
                            <div class="layui-input-inline">
                                <input type="text" id="customerNo" name="customerNo" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                                <!--<font id="customerNo" lay-filter="customerNo"></font>-->
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">主要联系方式</label>
                            <div class="layui-input-inline">
                                <select lay-verify="required" name="customerContactType" id="customerContactType" lay-filter="customerContactType">
                                    <option value="">请选择</option>
                                    <option value="1">手机</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">手机号码</label>
                            <div class="layui-input-inline">
                                <input type="text" name="customerContactWay" lay-verify="required" autocomplete="off" class="layui-input" lay-filter="customerContactWay">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item isShowIdCard" style="display: none">
                        <div class="layui-inline">
                            <label class="layui-form-label">户籍</label>
                            <div class="layui-input-inline">
                                <input type="text" id="census" name="census" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                        <div class="layui-inline"style="line-height:37px">
                            <label class="layui-form-label">年龄</label>
                            <div class="layui-input-inline">
                                <input type="text" id="age" name="age" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                        <div class="layui-inline ">
                            <label class="layui-form-label">性别</label>
                            <div class="layui-input-inline">
                                <input type="text" id="sex" name="sex" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div id="businessInfoDiv">
                <!--线索信息-->
                <form class="layui-form" action="" lay-filter="businessInfo" id="businessInfo">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        <legend>线索信息</legend>
                    </fieldset>
                    <!-- 现归属机构 -->
                    <input id="boSaleOrgName" lay-filter="boSaleOrgName" type="hidden" value=""/>
                    <!-- 现归属人员 -->
                    <input id="boSaleUserName" lay-filter="boSaleUserName" type="hidden" value=""/>

                    <div class="layui-form-item" id="businessInfoHideDiv">
                        <div class="layui-inline" style="line-height:37px">
                            <label class="layui-form-label">线索编号</label>
                            <div class="layui-input-inline">
                                <input type="text" id="businessNo" name="businessNo" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                                <!--<font id="businessNo" lay-filter="businessNo"></font>-->
                            </div>
                        </div>
                        <div class="layui-inline" style="line-height:37px">
                            <label class="layui-form-label">线索状态</label>
                            <div class="layui-input-inline">
                                <input type="text" id="businessStatus" name="businessStatus" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                                <!--<font id="businessStatus" lay-filter="businessStatus"></font>-->
                            </div>
                        </div>
                        <div class="layui-inline" style="line-height:37px">
                            <label class="layui-form-label">合作渠道</label>
                            <div class="layui-input-inline">
                                <input type="text" id="boChannelPartner" name="boChannelPartner" lay-verify="required" autocomplete="off" class="layui-input" disabled>
                                <!--<font id="boChannelPartner" lay-filter="boChannelPartner"></font>-->
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline ">
                            <label class="layui-form-label">车牌所在地</label>
                            <div class="layui-input-inline">
                                <input type="text" lay-filter="boLicenseArea" name="boLicenseArea" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">车辆品牌</label>
                            <div class="layui-input-inline">
                                <input type="text" lay-filter="boCarBrand" name="boCarBrand" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">贷款金额(元)</label>
                            <div class="layui-input-inline">
                                <input type="text" lay-filter="boRegisterAmount" lay-verify="customMoney" name="boRegisterAmount" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline" id="area-picker">
                            <label class="layui-form-label">业务区域</label>
                            <div class="layui-input-inline">
                                <select name="boProvince" class="province-selector" lay-verify="required" disabled>
                                    <option value="">省</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="boCity" id="boCity" class="city-selector" lay-verify="required" disabled>
                                    <option value="">市</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">业务类型</label>
                            <div class="layui-input-inline">
                                <select name="boType" id="boType" lay-filter="boType" lay-verify="required" disabled>
                                    <option value="">请选择</option>
                                    <option value="2">新车</option>
                                    <option value="3">车抵贷</option>
                                    <option value="4">二手车</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">关键字</label>
                            <div class="layui-input-inline" id="tags">
                                <input type="text" name="boKeyword" id="inputTags"  autocomplete="off" lay-verify="required">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">线索来源</label>
                            <div class="layui-input-inline">
                                <input type="text" lay-filter="boCluesDescribe" lay-verify="boCluesDescribe" name="boCluesDescribe" autocomplete="off" class="layui-input" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">备注</label>
                        <div class="layui-input-block">
                            <textarea id="boDesc" lay-filter="boDesc" name="boDesc" class="layui-textarea" lay-verify="required" maxlength="300" style="width:99.4%"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item" id="submitBusinessButDiv">
                        <div class="layui-input-block">
                        </div>
                    </div>
                </form>
                <!-- 线索信息 end -->
                <!-- 线索分配记录 -->
                <div id="distributionInfoDiv">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        <legend>线索分配记录</legend>
                    </fieldset>
                    <table class="layui-hide" id="distributionInfo" lay-filter="distributionInfo"></table>
                    <div class="layui-form-item">
                        <div class="layui-input-block" style="text-align:center">
                            <a id="returnBut" class="layui-btn" href="javascript:;">
                                返回
                            </a>
                            <a id="adjustmentBut" class="layui-btn" href="javascript:;">
                                重新分配
                            </a>
                            <a id="BusinessRecord" class="layui-btn" href="javascript:;" lay-filter="BusinessRecord">
                                跟进记录
                            </a>
                        </div>
                    </div>
                </div>

                <script type="text/html" id="distributionBar">
                    <!-- <a class="layui-btn layui-btn-xs data-count-edit" lay-event="edit">详情</a> -->
                    <a class="layui-btn layui-btn-xs layui-btn-danger data-count-delete" lay-event="info">跟进记录</a>
                </script>
                <script type="text/html" id="indexTpl">
                    {{d.LAY_TABLE_INDEX+1}}
                </script>
            </div>
        </div>

    </div>
</div>

<script src="../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script src="js/common.js?v=1.0.4" charset="utf-8"></script>
<script src="../js/ajaxhook.min.js?v=1.0.4" charset="utf-8"></script>
<script src="../js/httpIntercept.js?v=1.0.4" charset="utf-8"></script>
<script>
    layui.use(['layuimini', 'form', 'layedit', 'laydate', 'table', 'layarea', 'inputTags', 'enhanceForm', 'element','zlhjConfig'], function () {
        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , table = layui.table
            , layuimini = layui.layuimini
            , layarea = layui.layarea
            , inputTags = layui.inputTags
            , enhanceForm = layui.enhanceForm
            , element = layui.element
            , zlhjConfig = layui.zlhjConfig
            , $ = layui.jquery;

        //权限设置
        //TODO LATER
        let user = layui.sessionData('sessionData').userSession;
           // if (user.userRole === 3 ){//如果是 '管理人员 '则隐藏操作
           //     $('#adjustmentBut').show();
           // }else {
           //     $('#adjustmentBut').hide();
           // }
        // 接收联系方式的数据
        window.otherContactsInfoData;
        let tipDivCloseBut;
        // 控制其他联系方式的
        let otherContacts_operation = parseInt($('#otherContacts_operation').val())===0?false:true;
        let orgInfoForm = new enhanceForm({
                elem: '#orgInfo'
            });
        let businessInfoForm = new enhanceForm({
                elem: '#businessInfo'
            });

        // 初始加载
        layarea.render({
            elem: '#area-picker',
            data: {
                province: '',
                city: '',
                county: '',
            },
            change: function (res) {
                //选择结果
                console.log(res);
            }
        });
        let keyWordInfo = inputTags.render({
            elem:'#inputTags',//定义输入框input对象
            close: true,
            // content: ['标题一','标题二'],//默认标签
            // aldaBtn: true,//是否开启获取所有数据的按钮
            done: function(value){ //回车后的回调
                console.log(value)
            }
        });

        //自定义验证规则
        form.verify({
            title: function (value) {
                if (value.length < 5) {
                    return '标题至少得5个字符啊';
                }
            }
            , pass: [
                /^[\S]{6,12}$/
                , '密码必须6到12位，且不能出现空格'
            ]
            , content: function (value) {
                layedit.sync(editIndex);
            },
            customPhone: [/(^$)|^1\d{10}$/, '请输入正确的手机号'],
            customEmail: [/(^$)|^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/, '邮箱格式不正确'],
            customUrl: [/(^$)|(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/, '链接格式不正确'],
            customNumber: [/(^$)|^\d+$/, '只能填写数字'],
            customMoney: [/(^$)|^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/, '请填写正确的金额,最多两位小数'],
            customDate: [/(^$)|^(\d{4})[-\/](\d{1}|0\d{1}|1[0-2])([-\/](\d{1}|0\d{1}|[1-2][0-9]|3[0-1]))*$/, '日期格式不正确'],
            customIdentity: [/(^$)|(^\d{15}$)|(^\d{17}(x|X|\d)$)/, '请输入正确的身份证号']
        });


        // 线索分配记录 table
        window.distributionData = () => {
            let hideFlag = false;
            /*let user = layui.sessionData('sessionData').userSession;
            if (user.userRole===1){//如果是 '名单导入 '则隐藏操作
                hideFlag = true;
            }*/
            table.render({
                elem: '#distributionInfo',
                url: `${zlhjConfig.baseUrl}/businessOpportunity/distributionList`,
                response: {
                    // statusName: 'state' //规定数据状态的字段名称，默认：code
                    statusCode: 'Y' //规定成功的状态码，默认：0
                    // ,dataName: 'userList' //规定数据列表的字段名称，默认：data
                },
                contentType: 'application/json',
                parseData: function(res) {
                    return {
                        "code": res.state,
                        "msg": res.msg,
                        "data": res.boList
                    };
                },
                where: {
                    "boId": $('#businessNo').val()
                },
                method:'post',
                cols: [[
                    {field: 'orNewOrgName', title: '销售机构', align: "center"},
                    {field: 'orNewOwnerName', title: '销售人员', align: "center"},
                    // {title: '操作', hide: hideFlag, minWidth: 100, templet: '#distributionBar', fixed: "right", align: "center"}
                ]],
                // data:[],
            });
        }

        // 页面初始化赋值
        if ($('#boIdHidden').val()!==""){
            init();
        };

        function init(){
            // 调用详情接口
            fetch(`${zlhjConfig.baseUrl}/businessOpportunity/getBO`,{
                method: 'POST',
                body: `{'boId':'${$('#boIdHidden').val()}'}`,
                headers: new Headers({
                    'Content-Type': 'application/json'
                })
            }).then(res=>res.json()).then(
                data => {
                    console.log('线索详情', data);
                    if (data.state==='Y'){
                        let boInfoData = data.boInfo;
                        $('#businessNo').val(boInfoData.boId);
                        $('#customerNo').val(boInfoData.boCustomerId);
                        $('#boChannelPartner').val(getCoChannel(boInfoData.channelName));

                        $('#businessStatus').val(getBoStateName(boInfoData.boState));

                        let channelId = boInfoData.channelName;
                        // let phoneNum
                        // if(channelId === 99){
                        //     phoneNum = boInfoData.boCustomerContactWay
                        // }else {
                        //     phoneNum = boInfoData.boCustomerContactWay.substr(0,3)+"****"+ boInfoData.boCustomerContactWay.substr(boInfoData.boCustomerContactWay.length - 4)
                        // }

                        form.val('orgInfo', {
                            "customerName": boInfoData['boCustomerName']
                            , "customerNo": boInfoData['boCustomerId']
                            , "customerContactWay":boInfoData['boCustomerContactWay']
                            , "customerContactType": boInfoData['boCustomerContactType']

                        });
                        //身份证
                        let IdCard = boInfoData.boCustomerIdno
                        console.log("IdCard",IdCard)
                        if(IdCard != null && IdCard != ""){
                            //户籍
                            $("#census").val(IdCard.substr(0,6));
                            //年龄
                            let date = new Date();
                            let year = date.getFullYear();
                            let age = year - IdCard.substr(6,4);
                            $("#age").val(age);
                            //性别
                            let s = IdCard.substr(IdCard.length-2,1)
                            if(s % 2 == 0){
                                $("#sex").val("女");
                            }else{
                                $("#sex").val("男");
                            }

                            $(".isShowIdCard").show();
                        }

                        // 因为我们对layui的省市插件不太懂，只能采用这种暴力方式
                        $('#boCity').empty().append(new Option(boInfoData['boCity'], boInfoData['boCity']));

                        form.val('businessInfo', {
                             "boProvince": boInfoData['boProvince']
                            , "boCity": boInfoData['boCity']
                            , "boType": boInfoData['boType']
                            , "boLicenseArea": boInfoData['boLicenseArea']
                            , "boCarBrand": boInfoData['boCarBrand']
                            , "boRegisterAmount": boInfoData['boRegisterAmount']
                            , "boCluesDescribe": boInfoData['boCluesDescribe']
                            , "boDesc": boInfoData['boDesc']

                        });
                        $('#boSaleOrgName').val(boInfoData['boSaleOrgName']);
                        $('#boSaleUserName').val(boInfoData['boSaleUserName']);
                        $('#boSaleUserId').val(boInfoData['boSaleUserId']);
                        $('#submitBusinessButDiv').hide();
                        $('#cusInfoSubmitButDiv').hide();
                        if (boInfoData.boKeyword != null && boInfoData.boKeyword != ''){
                            let defaultContent = boInfoData.boKeyword.split("|");
                            inputTags.render({
                                elem:'#inputTags',//定义输入框input对象
                                close: false,
                                content: defaultContent,//默认标签
                                // aldaBtn: true,//是否开启获取所有数据的按钮
                                done: function(value){ //回车后的回调
                                    console.log(value)
                                }
                            });
                        }
                        orgInfoForm.disableAll();
                        businessInfoForm.disableAll();
                        // getSSOrgList();
                        distributionData();
                    } else {
                        layer.msg(`${data.msg}`);
                    }
                }
            );
        }
        // 返回按钮
        $('#returnBut').on('click',() => {
            let index = parent.layer.getFrameIndex(window.name); //得到当前iframe层的索引
            parent.layer.close(index); //执行关闭当前iframe层
        });

        // 调整归属人员
        let boId = $('#boIdHidden').val();
        let boSaleOrgName,boSaleUserName,boSaleUserId,oldState;
        $('#adjustmentBut').on('click',() => {
            $.ajax({
                type: "post",
                url: `${zlhjConfig.baseUrl}/businessOpportunity/getBO`,
                data: JSON.stringify({'boId':boId}),
                dataType: "json",
                contentType :'application/json',
                success:function (res) {
                    if(res.state == "Y"){
                        boSaleOrgName = res.boInfo.boSaleOrgName
                        boSaleUserName = res.boInfo.boSaleUserName
                        boSaleUserId = res.boInfo.boSaleUserId
                        oldState = res.boInfo.boState

                        layer.open({
                            type: 2,
                            title: '分配电销人员',
                            // shadeClose: true,
                            shade: 0.3,
                            maxmin: true, //开启最大化最小化按钮
                            area: ['70%', '90%'],
                            scrollbar:false,
                            content: './adjustment.html',
                            success: (layero, index) => {
                                let body = layer.getChildFrame('body', index);//建立父子联系
                                let iframeWin = window[layero.find('iframe')[0]['name']];
                                body.find('#boId').val(boId);
                                body.find('#orgName').val(boSaleOrgName);
                                body.find('#orgUserName').val(boSaleUserName);
                                //todo later
                                body.find('#boSaleUserId').val(boSaleUserId);
                                body.find('#oldState').val(oldState);

                            },
                            end: () => {
                                distributionData();
                            }
                        });

                    }
                },
                error:function (e) {
                    console.log("error")
                }
            });


        });
        // 跟进记录
        // table.on('tool(distributionInfo)', (obj) => {
        $("#BusinessRecord").on("click", () => {
            layer.open({
                type: 2,
                title: '跟进记录',
                shadeClose: true,
                shade: 0.3,
                maxmin: true, //开启最大化最小化按钮
                area: ['80%', '60%'],
                content: './follow-records.html',
                success:(layero, index) => {
                    let body = layer.getChildFrame('body', index);//建立父子联系
                    let iframeWin = window[layero.find('iframe')[0]['name']];
                    body.find('#boId').val($('#boIdHidden').val());
                    body.find('#reset').hide();
                    // $('.layui-layer-setwin').hide();
                }
            });
        });
        $('#customerName').focus();
    });
</script>
</body>
</html>
